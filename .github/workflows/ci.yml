name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint

      - name: Type check
        run: pnpm tsc -b

      - name: Run unit tests
        run: pnpm test -- --reporter=verbose --run

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: Run E2E tests
        run: pnpm test:e2e

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Build
        run: pnpm build

      - name: Verify build output
        run: |
          echo "Checking build output..."

          # Check that dist directory exists
          if [ ! -d "dist" ]; then
            echo "❌ Error: dist directory not found"
            exit 1
          fi

          # Check critical files exist
          required_files=(
            "dist/index.html"
            "dist/manifest.webmanifest"
            "dist/sw.js"
          )

          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Error: Required file $file not found"
              exit 1
            fi
            echo "✅ Found: $file"
          done

          # Check that assets were built
          if [ ! -d "dist/assets" ]; then
            echo "❌ Error: dist/assets directory not found"
            exit 1
          fi

          # Count files
          total_files=$(find dist -type f | wc -l)
          echo "Total files in dist: $total_files"

          # Check bundle size
          js_size=$(find dist/assets -name "*.js" -exec du -ch {} + | grep total$ | awk '{print $1}')
          css_size=$(find dist/assets -name "*.css" -exec du -ch {} + | grep total$ | awk '{print $1}')

          echo "JavaScript bundle size: $js_size"
          echo "CSS bundle size: $css_size"

          # Verify PWA icons exist
          if [ ! -d "dist/icons" ]; then
            echo "⚠️ Warning: icons directory not found in dist"
          else
            icon_count=$(find dist/icons -name "*.png" | wc -l)
            echo "✅ Found $icon_count PWA icons"
          fi

          echo "✅ Build verification complete!"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 7

  docker:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: loyalty-card-vault:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test Docker image
        run: |
          # Start container
          docker run -d --name test-container -p 8080:80 loyalty-card-vault:test

          # Wait for container to be ready
          echo "Waiting for container to start..."
          sleep 5

          # Test health endpoint
          echo "Testing health endpoint..."
          curl -f http://localhost:8080/health || exit 1

          # Test main page
          echo "Testing main page..."
          curl -f http://localhost:8080/ || exit 1

          # Test that it returns HTML
          response=$(curl -s http://localhost:8080/)
          if [[ $response != *"<!doctype html"* ]]; then
            echo "Error: Response is not HTML"
            exit 1
          fi

          echo "✅ Docker image tests passed!"

          # Cleanup
          docker stop test-container
          docker rm test-container

      - name: Check Docker image size
        run: |
          size=$(docker images loyalty-card-vault:test --format "{{.Size}}")
          echo "Docker image size: $size"

          # Extract numeric value (remove MB/GB suffix)
          size_mb=$(docker images loyalty-card-vault:test --format "{{.Size}}" | sed 's/MB//' | sed 's/GB//')

          echo "Image size: ${size_mb}MB"

          # Warn if image is larger than 50MB (it should be ~25MB)
          if (( $(echo "$size_mb > 50" | bc -l) )); then
            echo "⚠️ Warning: Image size is larger than expected (>50MB)"
          else
            echo "✅ Image size is optimal"
          fi
